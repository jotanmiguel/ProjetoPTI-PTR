{% load static %}
<!DOCTYPE html>

<html lang="en">
    <head>

        <!-- Basic Page Needs
        ================================================== -->
        <meta charset="utf-8">
        <title>Loja10</title>
    
    
        <!-- theme meta -->
        <meta name="theme-name" content="aviato" />
        
        <!-- Favicon -->
        <link rel="shortcut icon" type="image/x-icon" href="/static/images/favicon.png" />
        
        <!-- Themefisher Icon font -->
        <link rel="stylesheet" href="/static/plugins/themefisher-font/style.css">
        <!-- bootstrap.min css -->
        <link rel="stylesheet" href="/static/plugins/bootstrap/css/bootstrap.min.css">
        
        <!-- Animate css -->
        <link rel="stylesheet" href="/static/plugins/animate/animate.css">
        <link rel="stylesheet" href="/static/plugins/slick/slick-theme.css">
        
        <!-- Main Stylesheet -->
        <link rel="stylesheet" href="{% static 'style.css' %}">

        <!-- Auth0 Lock -->
        <script src="https://cdn.auth0.com/js/lock/12.0.2/lock.min.js"></script>
    
    </head>

    <body id="body">
    {% include 'navbar.html' %}


    <div class="container">
        <div class="row justify-content-center">
          <div class="col-md-6">
            <div id="hiw-login-container"></div>
          </div>
        </div>
    </div>

    <script>

        var Auth = (function() {
            var wm = new WeakMap();
            var privateStore = {};
            var lock;
            var options;

            function Auth() {
                this.options = {
                    container: 'hiw-login-container',
                    language: 'pt',
                    auth: {
                        redirectUrl: "http://127.0.0.1:8000",
                        responseType: "token"
                    },
                    mustAcceptTerms: true,
                    allowShowPassword: true,
                    additionalSignUpFields: [
                        {
                            name: "nome",
                            placeholder: "o seu nome de utilizador"
                        },
                        {
                            name: "numero",
                            placeholder: "o seu número de telemovel"
                        },
                        {
                            name: "morada",
                            placeholder: "a sua morada"
                        },
                        {
                            name: "codigo",
                            placeholder: "o seu codigo postal"
                        },
                        {
                            type: "select",
                            name: "tipo",
                            placeholder: "Cliente ou fornecedor?",
                            options: [
                            {value: "cliente", label: "Cliente"},
                            {value: "fornecedor", label: "Fornecedor"}
                            ]
                        }
                    ],
                    theme: {
                        primaryColor: '#31324F'
                    }
                };

                this.lock = new Auth0Lock(
                    "nL825O45PExkvhxEtgRoY28FtzK0ftp0",
                    "loja-10.eu.auth0.com",
                    this.options
                );
                wm.set(privateStore, {
                    appName: "Loja 10"
                });
            }

            Auth.prototype.getProfile = function() {
                return wm.get(privateStore).profile;
            };

            Auth.prototype.authn = function() {
                // Listen for the authentication event
                this.lock.on("authenticated", function(authResult) {
                    // Use the token in authResult to getUserInfo() and save it if necessary
                    this.getUserInfo(authResult.accessToken, function(error, profile) {
                        if (error) {
                            // Handle error
                            return;
                        }

                        // do not store Access Tokens unless absolutely necessary
                        wm.set(privateStore, {
                            accessToken: authResult.accessToken
                        });

                        wm.set(privateStore, {
                            profile: profile
                        });
                        
                    });
                });
            }
            return Auth;
        }());

        var authInstance = new Auth();
        document.addEventListener('DOMContentLoaded', function() {
            authInstance.lock.show();
        });

    </script>

    <!--
        Implement in the Auth0 app db to connect with mongo db
        Incompleto 
    <script>
        // When a user is created, Auth0 calls the following scripts
        // 1. Get User, verifies that the user does not already exist
        // 2. Create, creates the user in the exeternal db
        // 3. Login, Verifies that the user was created successfully

        function getByEmail(email, callback) {
            const MongoClient = require('mongodb@4.0.0').MongoClient;
            const client = new MongoClient('mongodb+srv://dbnew:dbnew@cluster0.piznqbl.mongodb.net/test');
            client.connect(function (err) {
                if (err) return callback(err);
                const db = client.db('projeto');
                const users = db.collection('projeto_users');
                users.findOne({ email: email }, function (err, user) {
                    client.close();
                    if (err) return callback(err);
                    if (!user) return callback(null, null);
                    return callback(null, {
                        user_id: user._id.toString(),
                        nickname: user.nickname,
                        email: user.email
                    });
                });
            });
        }

        function create(user, callback) {
            const bcrypt = require('bcrypt');
            const MongoClient = require('mongodb@4.0.0').MongoClient;
            const client = new MongoClient('mongodb+srv://dbnew:dbnew@cluster0.piznqbl.mongodb.net/test');
            client.connect(function (err) {
                if (err) return callback(err);
                const db = client.db('projeto');
                const users = db.collection('projeto_users');
                users.findOne({ email: user.email }, function (err, withSameMail) {
                    if (err || withSameMail) {
                        client.close();
                        return callback(err || new Error('the user already exists'));
                    }
                    bcrypt.hash(user.password, 10, function (err, hash) {
                        if (err) {
                            client.close();
                            return callback(err);
                        }
                        user.password = hash;
                        users.insert(user, function (err, inserted) {
                            client.close();
                            if (err) return callback(err);
                            callback(null);
                        });
                    });
                });
            });
        }

        function login(email, password, callback) {
            const bcrypt = require('bcrypt');
            const MongoClient = require('mongodb@4.0.0').MongoClient;
            const client = new MongoClient('mongodb+srv://dbnew:dbnew@cluster0.piznqbl.mongodb.net/test');
            client.connect(function (err) {
                if (err) return callback(err);
                const db = client.db('projeto');
                const users = db.collection('projeto_users');
                users.findOne({ email: email }, function (err, user) {
                    if (err || !user) {
                        client.close();
                        return callback(err || new WrongUsernameOrPasswordError(email));
                    }
                    bcrypt.compare(password, user.password, function (err, isValid) {
                        client.close();
                        if (err || !isValid) return callback(err || new WrongUsernameOrPasswordError(email));
                        return callback(null, {
                            user_id: user._id.toString(),
                            nickname: user.nickname,
                            email: user.email
                        });
                    });
                });
            });
        }

    </script>
    -->


    <!--
    <div>
        <div class="col-md-12 col-md-offset-3">
        <div class="row d-flex justify-content-center align-items-center">
            <div class="col-12 col-lg-7 col-xl-5">
            <div class="card" style="border-radius: 15px;">
                <div class="card-body p-5">

                <h2 class="text-uppercase text-center mb-5">Login</h2>

                <form method="post">
                    {% csrf_token %}
                    <div class="form-outline mb-4">

                    -->
                    <!--
                    <input type="text" id="form3Example1cg" class="form-control form-control-lg" />
                    <label class="form-label" for="form3Example1cg">Nome de utilizador</label>
                    -->

                    <!--
                    {{ form.username }}
                    <br>
                    <label class="form-label">Nome de Utilizador:</label>            
                    </div>

                    <div class="form-outline mb-4">
                    -->

                    <!--
                    <input type="password" id="form3Example4cg" class="form-control form-control-lg" />
                    <label class="form-label" for="form3Example4cg">Palavra-passe</label>
                    -->
                        
                    <!--
                        {{ form.password }}
                    <br>
                    <label class="form-label">Palavra-passe: </label>
                    </div>


                    <div>
                    <button type="submit"
                        class="btn btn-success btn-block btn-lg gradient-custom-4 text-body">Entrar</button>
                    </div>

                    <p class="text-center text-muted mt-5 mb-0">Ainda não tem conta? <a href="{% url 'registar' %}"
                        class="fw-bold text-body"><u>Registe-se aqui</u></a></p>

                </form>

                </div>
            </div>
            </div>
        </div>
        </div>
    </div>
    -->

    </body>

</html>